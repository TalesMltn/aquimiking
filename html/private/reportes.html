<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Reportes - TecMerch</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --azul-oscuro: #2c3e50;
      --azul-celeste: #3498db;
      --verde: #27ae60;
      --morado: #9b59b6;
      --gris-claro: #f8f9fa;
      --borde: #dee2e6;
      --texto: #2d3748;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #, f4f6f9;
    }

    .contenedor {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: var(--azul-oscuro);
      color: #fff;
      padding: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      margin-bottom: 30px;
    }

    .sidebar a {
      display: block;
      color: #ecf0f1;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 5px;
      text-decoration: none;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar a:hover,
    .sidebar a.activo {
      background: var(--azul-celeste);
    }

    .contenido {
      flex: 1;
      padding: 30px;
    }

    h1 {
      color: var(--azul-oscuro);
      margin-bottom: 10px;
      font-size: 1.8rem;
    }

    .subtitulo {
      color: #7f8c8d;
      margin-bottom: 25px;
      font-size: 1rem;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, .08);
      transition: transform .2s;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .card i {
      font-size: 2.2rem;
      color: var(--azul-celeste);
      margin-bottom: 12px;
    }

    .card .dato {
      font-size: 2.1rem;
      font-weight: bold;
      margin: 8px 0;
      color: var(--azul-oscuro);
    }

    .card span {
      font-size: 0.95rem;
      color: #7f8c8d;
    }

    .grafico {
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, .08);
      margin-bottom: 25px;
    }

    .grafico h3 {
      margin: 0 0 18px;
      color: var(--azul-oscuro);
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      height: 280px;
      position: relative;
    }

    .legend {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div class="contenedor">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="logo"><i class="bi bi-laptop"></i><span>TecMerch</span></div>
      <nav>
        <a href="./ventas/ventas.html"><i class="bi bi-cart"></i> Ventas</a>
        <a href="./productos/productos.html"><i class="bi bi-box-seam"></i> Productos</a>
        <a href="./clientes/clientes.html"><i class="bi bi-people"></i> Clientes</a>
        <a href="./categorias/categorias.html"><i class="bi bi-tags"></i> Categorías</a>
        <a href="./reportes.html" class="activo"><i class="bi bi-file-earmark-bar-graph"></i> Reportes</a>
        <a href="./citas_tecnicas/citas_tecnicas.html"><i class="bi bi-tools"></i> Citas Técnicas</a>
      </nav>
    </aside>

    <!-- CONTENIDO -->
    <main class="contenido">
      <h1>Reportes Mensuales</h1>
      <p class="subtitulo">Resumen del mes actual</p>

      <!-- TARJETAS -->
      <section class="dashboard">
        <div class="card">
          <i class="bi bi-cart4"></i>
          <div class="dato" id="totalVentas">0</div>
          <span>Ventas realizadas</span>
        </div>
        <div class="card">
          <i class="bi bi-tools"></i>
          <div class="dato" id="totalServicios">0</div>
          <span>Citas técnicas (mes)</span>
        </div>
        <div class="card">
          <i class="bi bi-people"></i>
          <div class="dato" id="totalClientes">0</div>
          <span>Total Clientes</span>
        </div>
      </section>

      <!-- GRÁFICO 1: Ventas por Semana -->
      <section class="grafico">
        <h3>Ventas por Semana</h3>
        <div class="chart-container"><canvas id="chartSemana"></canvas></div>
        <div class="legend" id="legendSemana"></div>
      </section>

      <!-- GRÁFICO 2: Ventas Acumuladas -->
      <section class="grafico">
        <h3>Ventas Acumuladas</h3>
        <div class="chart-container"><canvas id="chartAcumulado"></canvas></div>
        <div class="legend">100 % al final de la Semana 4</div>
      </section>

      <!-- GRÁFICO 3: Ventas por Día -->
      <section class="grafico">
        <h3>Ventas por Día</h3>
        <div class="chart-container"><canvas id="chartDia"></canvas></div>
        <div class="legend" id="legendDia"></div>
      </section>
    </main>
  </div>

  <!-- JAVASCRIPT -->
  <script>
    const cargar = key => JSON.parse(localStorage.getItem(key)) || [];
    const ventas = cargar('ventas');
    const citasTecnicas = cargar('citasTecnicas');
    const clientes = cargar('clientes');

    const hoy = new Date();
    const mes = hoy.getMonth();
    const año = hoy.getFullYear();

    // TARJETAS
    document.getElementById('totalVentas').textContent = ventas.length;
    document.getElementById('totalClientes').textContent = clientes.length;

    const citasMes = citasTecnicas.filter(c => {
      if (!c.fecha) return false;
      const f = new Date(c.fecha);
      return f.getMonth() === mes && f.getFullYear() === año;
    }).length;
    document.getElementById('totalServicios').textContent = citasMes;

    // ---------- GRÁFICOS ----------
    const ventasSemana = [0, 0, 0, 0];          // semana 1-4
    const ventasDia = Array(28).fill(0);    // día 1-28
    let total = 0;

    ventas.forEach(v => {
      total++;
      const f = new Date(v.fecha);
      const dia = f.getDate() - 1;
      const semana = Math.floor(dia / 7);
      if (semana < 4) ventasSemana[semana]++;
      if (dia < 28) ventasDia[dia]++;
    });

    const etiqSemana = ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'];
    const porcSemana = ventasSemana.map(v => total ? (v / total * 100).toFixed(1) : 0);
    const acumulado = [];
    ventasSemana.forEach((v, i) => acumulado.push((acumulado[i - 1] || 0) + v));
    const porcAcum = acumulado.map(v => total ? (v / total * 100).toFixed(1) : 0);
    const etiqDia = Array.from({ length: 28 }, (_, i) => `Día ${i + 1}`);

    // 1. Ventas por Semana
    new Chart('chartSemana', {
      type: 'bar',
      data: { labels: etiqSemana, datasets: [{ data: ventasSemana, backgroundColor: '#3498db', borderRadius: 6 }] },
      options: {
        responsive: true, plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} ventas (${porcSemana[ctx.dataIndex]}%)` } }
        }
      },
      plugins: [{
        afterDatasetsDraw(c) {
          const ctx = c.ctx;
          c.data.datasets[0].data.forEach((v, i) => {
            const bar = c.getDatasetMeta(0).data[i];
            ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(v, bar.x, bar.y - 10);
            ctx.font = '12px sans-serif'; ctx.fillStyle = '#7f8c8d';
            ctx.fillText(`${porcSemana[i]}%`, bar.x, bar.y + 10);
          });
        }
      }]
    });
    const semanaPico = ventasSemana.indexOf(Math.max(...ventasSemana)) + 1;
    document.getElementById('legendSemana').innerHTML =
      `Total:ordin ${total} ventas | Semana ${semanaPico}: ${Math.max(...ventasSemana)} ventas (${porcSemana[semanaPico - 1]}%)`;

    // 2. Ventas Acumuladas
    new Chart('chartAcumulado', {
      type: 'line',
      data: {
        labels: etiqSemana, datasets: [{
          data: acumulado, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)',
          fill: true, tension: 0.3, pointRadius: 6
        }]
      },
      options: {
        responsive: true, plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} ventas (${porcAcum[ctx.dataIndex]}%)` } }
        }
      },
      plugins: [{
        afterDatasetsDraw(c) {
          const ctx = c.ctx;
          c.data.datasets[0].data.forEach((v, i) => {
            const p = c.getDatasetMeta(0).data[i];
            ctx.fillStyle = '#fff'; ctx.font = 'bold 13px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(v, p.x, p.y - 12);
          });
        }
      }]
    });

    // 3. Ventas por Día
    new Chart('chartDia', {
      type: 'bar',
      data: {
        labels: etiqDia, datasets: [{
          data: ventasDia, backgroundColor: '#9b59b6',
          borderRadius: 4, barThickness: 8
        }]
      },
      options: {
        responsive: true, plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} venta${ctx.raw > 1 ? 's' : ''}` } }
        }
      },
      plugins: [{
        afterDatasetsDraw(c) {
          const ctx = c.ctx;
          c.data.datasets[0].data.forEach((v, i) => {
            if (v > 0) {
              const bar = c.getDatasetMeta(0).data[i];
              ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
              ctx.fillText(v, bar.x, bar.y - 5);
            }
          });
        }
      }]
    });
    const diaPico = ventasDia.indexOf(Math.max(...ventasDia)) + 1;
    const promDia = total ? (total / 28).toFixed(1) : 0;
    document.getElementById('legendDia').innerHTML =
      `Promedio: ~${promDia} ventas/día | Pico: Día ${diaPico} (${Math.max(...ventasDia)} ventas)`;
  </script>
</body>

</html>