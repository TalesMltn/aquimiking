<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes - TecMerch</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --azul-oscuro: #2c3e50;
      --azul-celeste: #3498db;
      --verde: #27ae60;
      --morado: #9b59b6;
      --gris-claro: #f8f9fa;
      --borde: #dee2e6;
      --texto: #2d3748;
    }

    body { margin: 0; font-family: Arial, sans-serif; background: #f4f6f9; }
    .contenedor { display: flex; min-height: 100vh; }

    /* === SIDEBAR === */
    .sidebar {
      width: 250px; background: var(--azul-oscuro); color: #fff; padding: 20px;
    }
    .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; margin-bottom: 30px; }
    .sidebar a {
      display: block; color: #ecf0f1; padding: 12px; border-radius: 6px; margin-bottom: 5px;
      text-decoration: none; font-size: 0.95rem; display: flex; align-items: center; gap: 10px;
    }
    .sidebar a:hover, .sidebar a.activo { background: var(--azul-celeste); }

    /* === CONTENIDO === */
    .contenido { flex: 1; padding: 30px; }
    h1 { color: var(--azul-oscuro); margin-bottom: 10px; font-size: 1.8rem; }
    .subtitulo { color: #7f8c8d; margin-bottom: 25px; font-size: 1rem; }

    /* === TARJETAS === */
    .dashboard {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .card {
      background: #fff; padding: 22px; border-radius: 12px; text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-3px); }
    .card i { font-size: 2.2rem; color: var(--azul-celeste); margin-bottom: 12px; }
    .card .dato { font-size: 2.1rem; font-weight: bold; margin: 8px 0; color: var(--azul-oscuro); }
    .card span { font-size: 0.95rem; color: #7f8c8d; }

    /* === GRÁFICOS === */
    .grafico {
      background: #fff; padding: 22px; border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 25px;
    }
    .grafico h3 {
      margin: 0 0 18px; color: var(--azul-oscuro); font-size: 1.15rem;
      display: flex; align-items: center; gap: 8px;
    }
    .chart-container { height: 280px; position: relative; }
    .legend { text-align: center; font-size: 0.9rem; color: #555; margin-top: 10px; font-style: italic; }
  </style>
</head>
<body>
  <div class="contenedor">
    <!-- ==================== SIDEBAR ==================== -->
    <aside class="sidebar">
      <div class="logo">
        <i class="bi bi-laptop"></i>
        <span>TecMerch</span>
      </div>
      <nav>
        <a href="./ventas/ventas.html"><i class="bi bi-cart"></i> Ventas</a>
        <a href="./productos/productos.html"><i class="bi bi-box-seam"></i> Productos</a>
        <a href="./clientes/clientes.html"><i class="bi bi-people"></i> Clientes</a>
        <a href="./categorias/categorias.html"><i class="bi bi-tags"></i> Categorías</a>
        <a href="./reportes.html" class="activo"><i class="bi bi-file-earmark-bar-graph"></i> Reportes</a>
        <a href="./citas_tecnicas/citas_tecnicas.html"><i class="bi bi-tools"></i> Citas Técnicas</a>
      </nav>
    </aside>

    <!-- ==================== CONTENIDO ==================== -->
    <main class="contenido">
      <h1><i class="bi bi-graph-up"></i> Reportes Mensuales</h1>
      <p class="subtitulo">Resumen del mes actual</p>

      <!-- === TARJETAS DINÁMICAS === -->
      <section class="dashboard">
        <div class="card">
          <i class="bi bi-cart4"></i>
          <div class="dato" id="totalVentas">0</div>
          <span>Ventas realizadas</span>
        </div>
        <div class="card">
          <i class="bi bi-tools"></i>
          <div class="dato" id="totalServicios">0</div>
          <span>Servicios técnicos</span>
        </div>
        <div class="card">
          <i class="bi bi-people"></i>
          <div class="dato" id="nuevosClientes">0</div>
          <span>Clientes nuevos</span>
        </div>
      </section>

      <!-- === GRÁFICO 1: Ventas por Semana === -->
      <section class="grafico">
        <h3><i class="bi bi-bar-chart-line"></i> Ventas por Semana</h3>
        <div class="chart-container">
          <canvas id="chartSemana"></canvas>
        </div>
        <div class="legend" id="legendSemana"></div>
      </section>

      <!-- === GRÁFICO 2: Ventas Acumuladas === -->
      <section class="grafico">
        <h3><i class="bi bi-graph-up-arrow"></i> Ventas Acumuladas</h3>
        <div class="chart-container">
          <canvas id="chartAcumulado"></canvas>
        </div>
        <div class="legend">100% al final de la Semana 4</div>
      </section>

      <!-- === GRÁFICO 3: Ventas por Día === -->
      <section class="grafico">
        <h3><i class="bi bi-calendar-week"></i> Ventas por Día</h3>
        <div class="chart-container">
          <canvas id="chartDia"></canvas>
        </div>
        <div class="legend" id="legendDia"></div>
      </section>
    </main>
  </div>

  <!-- ==================== JAVASCRIPT CON DATOS REALES ==================== -->
  <script>
    // === CARGAR DATOS DE localStorage ===
    function cargarDatos(key) {
      return JSON.parse(localStorage.getItem(key)) || [];
    }

    const ventas = cargarDatos('ventas');
    const productos = cargarDatos('productos');
    const clientes = cargarDatos('clientes');

    // === ACTUALIZAR TARJETAS ===
    document.getElementById('totalVentas').textContent = ventas.length;

    // Servicios técnicos: productos con categoría "Servicio Técnico"
    const servicios = productos.filter(p => p.categoria === 'Servicio Técnico').length;
    document.getElementById('totalServicios').textContent = servicios;

    // Clientes nuevos este mes
    const hoy = new Date();
    const mesActual = hoy.getMonth();
    const añoActual = hoy.getFullYear();
    const nuevosEsteMes = clientes.filter(c => {
      if (!c.fechaRegistro) return false;
      const fecha = new Date(c.fechaRegistro);
      return fecha.getMonth() === mesActual && fecha.getFullYear() === añoActual;
    }).length;
    document.getElementById('nuevosClientes').textContent = nuevosEsteMes;

    // === DATOS PARA GRÁFICOS ===
    const ventasPorSemana = [0, 0, 0, 0]; // Semana 1 a 4
    const ventasPorDia = Array(28).fill(0); // 28 días
    let totalVentas = 0;

    ventas.forEach(v => {
      totalVentas++;
      const fecha = new Date(v.fecha);
      const diaDelMes = fecha.getDate() - 1; // 0-index
      const semana = Math.floor(diaDelMes / 7); // 0 a 3

      if (semana >= 0 && semana < 4) {
        ventasPorSemana[semana]++;
      }
      if (diaDelMes >= 0 && diaDelMes < 28) {
        ventasPorDia[diaDelMes]++;
      }
    });

    const etiquetasSemana = ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'];
    const porcSemana = ventasPorSemana.map(v => totalVentas > 0 ? (v / totalVentas * 100).toFixed(1) : 0);

    // Acumulado
    const acumulado = [];
    ventasPorSemana.forEach((v, i) => acumulado.push((acumulado[i-1] || 0) + v));
    const porcAcumulado = acumulado.map(v => totalVentas > 0 ? (v / totalVentas * 100).toFixed(1) : 0);

    const etiquetasDia = Array.from({length: 28}, (_, i) => `Día ${i+1}`);

    // === GRÁFICO 1: Ventas por Semana ===
    new Chart(document.getElementById('chartSemana'), {
      type: 'bar',
      data: {
        labels: etiquetasSemana,
        datasets: [{
          data: ventasPorSemana,
          backgroundColor: '#3498db',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} ventas (${porcSemana[ctx.dataIndex]}%)` }}
        },
        scales: { y: { beginAtZero: true }}
      },
      plugins: [{
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets[0].data.forEach((v, i) => {
            const bar = chart.getDatasetMeta(0).data[i];
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(v, bar.x, bar.y - 10);
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#7f8c8d';
            ctx.fillText(`${porcSemana[i]}%`, bar.x, bar.y + 10);
          });
        }
      }]
    });
    const semanaPico = ventasPorSemana.indexOf(Math.max(...ventasPorSemana)) + 1;
    document.getElementById('legendSemana').innerHTML = `Total: ${totalVentas} ventas | Semana ${semanaPico}: ${Math.max(...ventasPorSemana)} ventas (${porcSemana[semanaPico - 1]}%)`;

    // === GRÁFICO 2: Ventas Acumuladas ===
    new Chart(document.getElementById('chartAcumulado'), {
      type: 'line',
      data: {
        labels: etiquetasSemana,
        datasets: [{
          data: acumulado,
          borderColor: '#27ae60',
          backgroundColor: 'rgba(39, 174, 96, 0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} ventas (${porcAcumulado[ctx.dataIndex]}%)` }}
        },
        scales: { y: { beginAtZero: true, max: totalVentas + 10 }}
      },
      plugins: [{
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets[0].data.forEach((v, i) => {
            const point = chart.getDatasetMeta(0).data[i];
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 13px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(v, point.x, point.y - 12);
          });
        }
      }]
    });

    // === GRÁFICO 3: Ventas por Día ===
    new Chart(document.getElementById('chartDia'), {
      type: 'bar',
      data: {
        labels: etiquetasDia,
        datasets: [{
          data: ventasPorDia,
          backgroundColor: '#9b59b6',
          borderRadius: 4,
          barThickness: 8
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => `${ctx.raw} venta${ctx.raw > 1 ? 's' : ''}` }}
        },
        scales: {
          y: { beginAtZero: true, max: Math.max(...ventasPorDia) + 2 },
          x: { ticks: { maxTicksLimit: 28 }}
        }
      },
      plugins: [{
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets[0].data.forEach((v, i) => {
            if (v > 0) {
              const bar = chart.getDatasetMeta(0).data[i];
              ctx.fillStyle = '#2c3e50';
              ctx.font = 'bold 11px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText(v, bar.x, bar.y - 5);
            }
          });
        }
      }]
    });
    const diaPico = ventasPorDia.indexOf(Math.max(...ventasPorDia)) + 1;
    const promedioDia = totalVentas > 0 ? (totalVentas / 28).toFixed(1) : 0;
    document.getElementById('legendDia').innerHTML = `Promedio: ~${promedioDia} ventas/día | Pico: Día ${diaPico} (${Math.max(...ventasPorDia)} ventas)`;
  </script>
</body>
</html>