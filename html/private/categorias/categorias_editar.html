<script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (!id) {
    alert("Error: Falta el ID de la categoría.");
    window.location.href = "categorias.html";
    throw new Error("ID no proporcionado"); // Detiene ejecución
  }

  const categorias = JSON.parse(localStorage.getItem("categorias")) || [];
  const categoria = categorias.find(c => c.id === id);
  if (!categoria) {
    alert("Categoría no encontrada.");
    window.location.href = "categorias.html";
  }

  // Rellenar formulario
  document.getElementById("id").value = categoria.id;
  document.getElementById("nombre").value = categoria.nombre;
  document.getElementById("descripcion").value = categoria.descripcion;

  // Guardar cambios
  document.getElementById("formEditar").onsubmit = function(e) {
    e.preventDefault();

    const nuevoNombre = document.getElementById("nombre").value.trim();
    const descripcion = document.getElementById("descripcion").value.trim();

    if (!nuevoNombre || !descripcion) {
      alert("Completa todos los campos.");
      return;
    }

    if (categorias.some(c => c.id !== id && c.nombre.toLowerCase() === nuevoNombre.toLowerCase())) {
      alert("Ya existe una categoría con ese nombre.");
      return;
    }

    const indice = categorias.findIndex(c => c.id === id);
    const viejoNombre = categorias[indice].nombre;

    categorias[indice] = { id, nombre: nuevoNombre, descripcion };
    localStorage.setItem("c |ategorias", JSON.stringify(categorias));

    // Actualizar productos
    const productos = JSON.parse(localStorage.getItem("productos")) || [];
    productos.forEach(p => {
      if (p.categoria === viejoNombre) p.categoria = nuevoNombre;
    });
    localStorage.setItem("productos", JSON.stringify(productos));

    alert("Categoría actualizada.");
    window.location.href = "categorias.html";
  };
</script>